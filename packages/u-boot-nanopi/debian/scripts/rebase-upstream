#!/bin/bash

set -eE 
trap 'echo Error: in $0 on line $LINENO' ERR

cd "$(dirname -- "$(readlink -f -- "$0")")" && cd ../..

# Add an upstream remote and fetch it
upstream_git=https://github.com/radxa/u-boot.git
if ! git remote | grep -qxF upstream ; then
    git remote add upstream "${upstream_git}"
fi
git fetch upstream

# Current upstream commit and version
. debian/upstream

# New upstream commit and version
new_commit=$(git rev-parse upstream/"${BRANCH}")
new_version=$(git show -s --date=format:'2017.09+%Y%m%d' --format=%cd "${new_commit}").git${new_commit::8}

# Rebase onto upstream
git rebase "${new_commit}"

# Create the rebase commit
{
    echo "GIT=${upstream_git}"
    echo "COMMIT=${new_commit}"
    echo "BRANCH=${BRANCH}"
    echo "VERSION=${new_version}"
} > debian/upstream
cd debian
git add upstream
git commit -s -m "rebase to upstream commit ${new_commit}"
